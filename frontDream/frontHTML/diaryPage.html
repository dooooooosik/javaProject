<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>내가 작성한 일기들</title>
  <link rel="stylesheet" href="/css/diaryPage.css">
</head>
<body>
  <a href="mainPage.html" class="back-link">← 뒤로 가기</a>
  <header>
    <nav class="user-menu">
      <button id="auth-btn" class="top-bar-button">로그인</button>
    </nav>
    <div class="top-bar">
      <h1 class="title">내가 작성한 일기들</h1>
    </div>
  </header>

  <div class="write-diary-wrapper">
    <button id="write-diary-btn">일기 작성하기</button>
  </div>
  
  <main>
    <div id="diary-container" class="diary-container"></div>
    <div class="pagination">
      <button id="prev-btn" class="pagination-btn" disabled>이전</button>
      <button id="next-btn" class="pagination-btn">다음</button>
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const authBtn = document.getElementById("auth-btn");
      if (!authBtn) {
        console.error("auth-btn 요소를 찾을 수 없습니다.");
      } else {
        const isLoggedIn = localStorage.getItem("isLoggedIn");
        authBtn.textContent = isLoggedIn ? "로그아웃" : "로그인";
        authBtn.addEventListener("click", () => {
          if (isLoggedIn) {
            localStorage.removeItem("isLoggedIn");
            localStorage.removeItem("userId");
            window.location.reload();
          } else {
            window.location.href = "/frontHTML/loginPage.html";
          }
        });
      }

      const writeDiaryBtn = document.getElementById("write-diary-btn");
      if (writeDiaryBtn) {
        writeDiaryBtn.addEventListener("click", () => {
          if (localStorage.getItem("isLoggedIn")) {
            window.location.href = "/frontHTML/diaryWrite.html";
          } else {
            alert("로그인 후 일기 작성이 가능합니다.");
          }
        });
      }

      let diaries = [];
      let currentPage = 1;
      const diariesPerPage = 5;

      function renderDiaries(page) {
        const container = document.getElementById("diary-container");
        container.innerHTML = ""; 

        const startIndex = (page - 1) * diariesPerPage;
        const endIndex = page * diariesPerPage;
        const currentDiaries = diaries.slice(startIndex, endIndex);

        currentDiaries.forEach((diary) => {
          const diaryDiv = document.createElement("div");
          diaryDiv.classList.add("diary-box");

          const formattedDate = diary.createdAt
            ? new Date(diary.createdAt).toLocaleDateString("ko-KR", {
                year: "numeric",
                month: "long",
                day: "numeric",
              })
            : "날짜 없음";

          diaryDiv.innerHTML = `
            <h2 class="diary-title">${diary.title}</h2>
            <p class="diary-date">${formattedDate}</p>
            <p class="diary-content">${diary.content}</p>
            <div class="diary-footer">
              <button class="edit-diary-btn" data-id="${diary.id}">수정</button>
              <button class="delete-diary-btn" data-id="${diary.id}">삭제</button>
            </div>
          `;
          container.appendChild(diaryDiv);
        });

        document.getElementById("prev-btn").disabled = page === 1;
        document.getElementById("next-btn").disabled = endIndex >= diaries.length;

        addDiaryEventListeners();
      }

      function addDiaryEventListeners() {
        document.querySelectorAll(".edit-diary-btn").forEach((button) => {
          button.addEventListener("click", (event) => {
            const diaryId = event.target.dataset.id;
            const diary = diaries.find((d) => d.id === parseInt(diaryId));
            if (diary) {
              localStorage.setItem("editDiary", JSON.stringify(diary));
              window.location.href = "/frontHTML/diaryWrite.html";
            }
          });
        });

        document.querySelectorAll(".delete-diary-btn").forEach((button) => {
          button.addEventListener("click", (event) => {
            const diaryId = event.target.dataset.id;
            if (confirm("정말로 이 일기를 삭제하시겠습니까?")) {
              deleteDiary(diaryId);
            }
          });
        });
      }

      function deleteDiary(diaryId) {
        fetch(`http://127.0.0.1:8080/api/diaries/${diaryId}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${localStorage.getItem("token")}` },
        })
          .then((response) => response.ok ? response.json() : Promise.reject("삭제 실패"))
          .then(() => {
            diaries = diaries.filter((diary) => diary.id !== parseInt(diaryId));
            renderDiaries(currentPage);
          })
          .catch((error) => alert("일기를 삭제하는 중 문제가 발생했습니다."));
      }

      function fetchDiaries() {
        fetch('http://127.0.0.1:8080/api/diaries', {
          method: 'GET',
          headers: { Authorization: `Bearer ${localStorage.getItem("token")}` },
        })
          .then(response => response.json())
          .then(data => {
            diaries = data;
            diaries.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            renderDiaries(currentPage);
          });
      }

      fetchDiaries();
    });
  </script>
</body>
</html>
