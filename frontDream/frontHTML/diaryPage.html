<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‚´ê°€ ì‘ì„±í•œ ì¼ê¸°ë“¤</title>
  <link rel="stylesheet" href="/css/diaryPage.css">
</head>
<body>
  <a href="mainPage.html" class="back-link">â† ë’¤ë¡œ ê°€ê¸°</a>
  <header>
    <nav class="user-menu">
      <button id="auth-btn" class="top-bar-button">ë¡œê·¸ì¸</button>
    </nav>
    <div class="top-bar">
      <h1 class="title">ë‚´ê°€ ì‘ì„±í•œ ì¼ê¸°ë“¤</h1>
    </div>
  </header>

  <div class="write-diary-wrapper">
    <button id="write-diary-btn">ì¼ê¸° ì‘ì„±í•˜ê¸°</button>
  </div>
  
  <main>
    <div id="diary-container" class="diary-container"></div>
    <div class="pagination">
      <button id="prev-btn" class="pagination-btn" disabled>ì´ì „</button>
      <button id="next-btn" class="pagination-btn">ë‹¤ìŒ</button>
    </div>
  </main>

  <script>
document.addEventListener("DOMContentLoaded", () => {
  const authBtn = document.getElementById("auth-btn");
  const prevBtn = document.getElementById("prev-btn");
  const nextBtn = document.getElementById("next-btn");

  const isLoggedIn = localStorage.getItem("isLoggedIn");
  authBtn.textContent = isLoggedIn ? "ë¡œê·¸ì•„ì›ƒ" : "ë¡œê·¸ì¸";
  authBtn.addEventListener("click", () => {
    if (isLoggedIn) {
      localStorage.removeItem("isLoggedIn");
      localStorage.removeItem("userId");
      window.location.reload();
    } else {
      window.location.href = "/frontHTML/loginPage.html";
    }
  });

  const writeDiaryBtn = document.getElementById("write-diary-btn");
  writeDiaryBtn.addEventListener("click", () => {
    if (localStorage.getItem("isLoggedIn")) {
      window.location.href = "/frontHTML/diaryWrite.html";
    } else {
      alert("ë¡œê·¸ì¸ í›„ ì¼ê¸° ì‘ì„±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    }
  });

  let diaries = [];
  let currentPage = 1;
  const diariesPerPage = 5;

  function renderDiaries(page) {
    const container = document.getElementById("diary-container");
    container.innerHTML = "";  // ì´ì „ ì½˜í…ì¸ ë¥¼ ì§€ìš°ê¸°

    const startIndex = (page - 1) * diariesPerPage;
    const endIndex = page * diariesPerPage;
    const currentDiaries = diaries.slice(startIndex, endIndex);

    currentDiaries.forEach((diary) => {
      const diaryDiv = document.createElement("div");
      diaryDiv.classList.add("diary-box");

      const formattedDate = diary.createdAt
        ? new Date(diary.createdAt).toLocaleDateString("ko-KR", {
            year: "numeric",
            month: "long",
            day: "numeric",
          })
        : "ë‚ ì§œ ì—†ìŒ";

      diaryDiv.innerHTML = `
        <h2 class="diary-title">${diary.title}</h2>
        <p class="diary-date">${formattedDate}</p>
        <p class="diary-content">${diary.content}</p>
        <div class="diary-footer">
          <button class="edit-diary-btn" data-id="${diary.id}">ìˆ˜ì •</button>
          <button class="delete-diary-btn" data-id="${diary.id}">ì‚­ì œ</button>
        </div>
      `;
      container.appendChild(diaryDiv);
    });

    prevBtn.disabled = page === 1;
    nextBtn.disabled = endIndex >= diaries.length;

    addDiaryEventListeners();
  }

  function addDiaryEventListeners() {
    // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ ì²˜ë¦¬
    document.querySelectorAll(".edit-diary-btn").forEach((button) => {
      button.addEventListener("click", (event) => {
        const diaryId = event.target.dataset.id;
        const diary = diaries.find((d) => d.id === parseInt(diaryId));
        if (diary) {
          localStorage.setItem("editDiary", JSON.stringify(diary));
          window.location.href = "/frontHTML/diaryWrite.html";
        }
      });
    });

    // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì²˜ë¦¬
    document.querySelectorAll(".delete-diary-btn").forEach((button) => {
  button.addEventListener("click", (event) => {
    const diaryId = event.target.dataset.id;
    const token = localStorage.getItem("token");

    fetch(`http://127.0.0.1:8080/api/diaries/${diaryId}`, {
      method: 'DELETE',
      headers: {
        Authorization: `Bearer ${token}`
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`ì‚­ì œ ì‹¤íŒ¨! ìƒíƒœ ì½”ë“œ: ${response.status}`);
      }
      return response.status === 204 ? null : response.json(); // ğŸ”¥ 204ì¼ ë•Œ json íŒŒì‹± ê±´ë„ˆëœ€
    })
    .then(() => {
      alert("ì¼ê¸° ì‚­ì œ ì™„ë£Œ!");
      fetchDiaries();  // ì‚­ì œ í›„ ì¼ê¸° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    })
    .catch(error => {
      alert("ì‚­ì œ ì‹¤íŒ¨!");
      console.error("ì‚­ì œ ì‹¤íŒ¨ ì›ì¸:", error);
        });
      });
    });
  }

  function fetchDiaries() {
    fetch('http://127.0.0.1:8080/api/diaries', {
      method: 'GET',
      headers: { Authorization: `Bearer ${localStorage.getItem("token")}` },
    })
    .then(response => response.json())
    .then(data => {
      diaries = data;
      renderDiaries(currentPage);
    })
    .catch(error => {
      alert("ì¼ê¸° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      console.error(error);
    });
  }

  fetchDiaries();
});


  </script>
</body>
</html>
